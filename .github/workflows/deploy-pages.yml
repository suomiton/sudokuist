name: ğŸš€ Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ¦€ Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown

    - name: ğŸ“¦ Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: ğŸŒ Install wasm-pack
      uses: jetli/wasm-pack-action@v0.4.0
      with:
        version: 'latest'

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bc gzip

    - name: ğŸ“¦ Install npm dependencies
      run: npm ci

    - name: ğŸ”§ Setup Pages
      uses: actions/configure-pages@v4
      with:
        static_site_generator: vite

    - name: ğŸ—ï¸ Build WASM (Release)
      run: |
        echo "ğŸ¦€ Building WASM with release optimizations..."
        wasm-pack build --target web --out-dir pkg --release

    - name: ğŸ—ï¸ Build with optimizations
      run: |
        echo "ğŸ“ Copying WASM files for TypeScript..."
        cp -r pkg src/
        echo "ğŸ“ Copying WASM files to public directory for Vite..."
        cp pkg/sudoku_wasm.js pkg/sudoku_wasm_bg.wasm public/
        echo "ï¿½ Running TypeScript type check..."
        NODE_ENV=production npm run type-check
        echo "ğŸ”¨ Building with Vite in production mode with full optimization..."
        NODE_ENV=production npx vite build --mode production --base=/sudokuist/
        echo "ğŸ—œï¸ Compressing files with gzip for better performance..."
        find dist -type f \( -name "*.js" -o -name "*.css" -o -name "*.html" -o -name "*.wasm" \) -exec gzip -9 -k {} \;

    - name: ğŸ“‹ Copy additional assets
      run: |
        echo "ğŸ“‹ Copying additional styles..."
        mkdir -p dist/styles
        cp -r styles/* dist/styles/ 2>/dev/null || true
        echo "ğŸ“‹ Verifying WASM files are in place..."
        ls -la dist/sudoku_wasm* || echo "WASM files not found in dist, this might cause loading issues"

    - name: ğŸ“Š Generate build report
      run: |
        echo "ğŸ“Š Generating build analysis..."
        echo "## Build Size Report" > build-report.md
        echo "\`\`\`" >> build-report.md
        du -sh dist/* | sort -hr >> build-report.md
        echo "\`\`\`" >> build-report.md
        echo "" >> build-report.md
        echo "### File Sizes (Original vs Compressed)" >> build-report.md
        echo "\`\`\`" >> build-report.md
        find dist -name "*.js" -o -name "*.css" -o -name "*.html" -o -name "*.wasm" | while read file; do
          if [ -f "$file" ]; then
            original_size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
            if [ -f "$file.gz" ]; then
              gzipped_size=$(stat -c%s "$file.gz" 2>/dev/null || stat -f%z "$file.gz")
              compression_ratio=$(echo "scale=1; 100 - ($gzipped_size * 100 / $original_size)" | bc -l 2>/dev/null || echo "N/A")
              echo "$(basename "$file"): ${original_size} bytes â†’ ${gzipped_size} bytes (${compression_ratio}% reduction)" >> build-report.md
            else
              echo "$(basename "$file"): ${original_size} bytes (no compression)" >> build-report.md
            fi
          fi
        done
        echo "\`\`\`" >> build-report.md
        echo "" >> build-report.md
        echo "### Minification Status" >> build-report.md
        echo "\`\`\`" >> build-report.md
        echo "âœ“ JavaScript: Minified with Terser (aggressive settings)" >> build-report.md
        echo "âœ“ CSS: Minified and optimized" >> build-report.md  
        echo "âœ“ HTML: Minified with html-minifier-terser" >> build-report.md
        echo "âœ“ WASM JS: Minified with custom plugin" >> build-report.md
        echo "âœ“ Compression: Gzip level 9 applied to all assets" >> build-report.md
        echo "\`\`\`" >> build-report.md
        cp build-report.md dist/

    - name: ğŸ“¤ Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist

  # Deploy job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: ğŸ“ Comment deployment URL
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ğŸš€ **Deployment Preview**: ${{ steps.deployment.outputs.page_url }}'
          })
